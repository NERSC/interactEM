name: Release Tagging on Merge

on:
  push:
    branches:
      - main

jobs:
  tag_release:
    permissions:
      contents: write
    runs-on: ubuntu-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.VERSION_BUMP }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Determine version from pyproject.toml
        id: get_version
        run: |
          python - <<'PY'
          import os
          import pathlib
          import tomllib

          pyproject = pathlib.Path("pyproject.toml")
          data = tomllib.loads(pyproject.read_text(encoding="utf-8"))
          version = data.get("project", {}).get("version")
          if not version:
              raise SystemExit("Version not found in pyproject.toml")

          print(f"Detected version: {version}")
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env:
              env.write(f"NEW_VERSION={version}\n")
          PY

      - name: Configure git user
        run: |
          git config --global user.email "ci-version-bot@users.noreply.github.com"
          git config --global user.name "CI Version Bot"

      - name: Create and push annotated tag
        env:
          NEW_VERSION: ${{ env.NEW_VERSION }}
        run: |
          TAG_NAME="v${NEW_VERSION}"

          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists on the remote. No new tag will be created."
            exit 0
          fi

          git tag -a "$TAG_NAME" -m "Official Release $TAG_NAME"
          git push origin "$TAG_NAME"
