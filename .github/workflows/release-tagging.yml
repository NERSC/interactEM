name: Tag Release

on:
  push:
    branches:
      - main
      - fix-release-workflow

jobs:
  tag_release:
    permissions:
      contents: write
    # if: startsWith(github.event.head_commit.message, 'chore(release):') || startsWith(github.event.head_commit.message, 'Release:')
    runs-on: ubuntu-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.VERSION_BUMP }}
          fetch-depth: 0 # needed because fetch-tags doesn't work as expected... 
          # open issue gh for 4 years... https://github.com/actions/checkout/issues/1471
          fetch-tags: true

      - name: Configure git user
        run: |
          git config --global user.email "ci-version-bot@users.noreply.github.com"
          git config --global user.name "CI Version Bot"

      - name: Check existing git tags
        run: | 
          git tag -l

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.12'

      - name: Get current version
        id: version
        shell: bash
        run: |
          current_version=$(uvx bump-my-version@latest show current_version)
          echo "tag=v${current_version}" >> "$GITHUB_OUTPUT"

      - name: Create and push annotated tag
        env:
          TAG_NAME: ${{ steps.version.outputs.tag }}
        run: |
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists. Skipping."
            echo "created=false" >> "$GITHUB_OUTPUT"
          else
            echo "Creating tag: $TAG_NAME"
            git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
            git push origin "$TAG_NAME"
            echo "created=true" >> "$GITHUB_OUTPUT"
          fi