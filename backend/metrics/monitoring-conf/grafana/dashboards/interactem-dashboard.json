{
  "id": null,
  "title": "Interactem Pipeline Monitoring",
  "tags": ["interactem", "prometheus", "pipeline"],
  "style": "light",
  "timezone": "browser",
  "refresh": "5s",
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "templating": {
    "list": [
      {
        "name": "pipeline_id",
        "type": "query",
        "query": "label_values(interactem_pipeline_active_ports, pipeline_id)",
        "refresh": 1,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "current": {
          "selected": false,
          "text": "All",
          "value": "$__all"
        },
        "hide": 0,
        "label": "Pipeline ID",
        "skipUrlSync": false
      },
      {
        "name": "operator_type",
        "type": "query",
        "query": "label_values(interactem_port_messages_sent_total, operator_type)",
        "refresh": 1,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "current": {
          "selected": false,
          "text": "All",
          "value": "$__all"
        },
        "hide": 0,
        "label": "Operator Type",
        "skipUrlSync": false
      },
      {
        "name": "rate_interval_short",
        "type": "custom",
        "query": "5s,10s,15s,30s",
        "multi": false,
        "includeAll": false,
        "hide": 0,
        "label": "Short Window",
        "skipUrlSync": false,
        "options": [
          {
            "text": "5 seconds",
            "value": "5s",
            "selected": true
          },
          {
            "text": "10 seconds",
            "value": "10s",
            "selected": false
          },
          {
            "text": "15 seconds",
            "value": "15s",
            "selected": false
          },
          {
            "text": "30 seconds",
            "value": "30s",
            "selected": false
          }
        ],
        "current": {
          "selected": true,
          "text": "5 seconds",
          "value": "5s"
        }
      },
      {
        "name": "rate_interval_long",
        "type": "custom",
        "query": "30s,1m,2m,5m",
        "multi": false,
        "includeAll": false,
        "hide": 0,
        "label": "Long Window",
        "skipUrlSync": false,
        "options": [
          {
            "text": "30 seconds",
            "value": "30s",
            "selected": true
          },
          {
            "text": "1 minute",
            "value": "1m",
            "selected": false
          },
          {
            "text": "2 minutes",
            "value": "2m",
            "selected": false
          },
          {
            "text": "5 minutes",
            "value": "5m",
            "selected": false
          }
        ],
        "current": {
          "selected": true,
          "text": "30 seconds",
          "value": "30s"
        }
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "title": "Service Overview",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
      "collapsed": false
    },
    {
      "id": 2,
      "title": "Service Status",
      "type": "stat",
      "targets": [
        {
          "expr": "interactem_service_status",
          "legendFormat": "{{service}}"
        }
      ],
      "gridPos": { "h": 4, "w": 8, "x": 0, "y": 1 },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "thresholds": {
            "steps": [
              { "color": "red", "value": 0 },
              { "color": "green", "value": 1 }
            ]
          },
          "mappings": [
            { "options": { "0": { "text": "Inactive" } }, "type": "value" },
            { "options": { "1": { "text": "Active" } }, "type": "value" }
          ]
        }
      }
    },
    {
      "id": 3,
      "title": "Monitored Pipelines",
      "type": "stat",
      "targets": [
        {
          "expr": "count(count by (pipeline_id) (interactem_pipeline_active_ports))",
          "legendFormat": "Pipelines"
        }
      ],
      "gridPos": { "h": 4, "w": 8, "x": 8, "y": 1 }
    },
    {
      "id": 4,
      "title": "Collection Errors",
      "type": "stat",
      "targets": [
        {
          "expr": "increase(interactem_metrics_collection_errors_total[5m])",
          "legendFormat": "{{error_type}}"
        }
      ],
      "gridPos": { "h": 4, "w": 8, "x": 16, "y": 1 },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "thresholds": {
            "steps": [
              { "color": "green", "value": 0 },
              { "color": "yellow", "value": 1 },
              { "color": "red", "value": 5 }
            ]
          }
        }
      }
    },
    {
      "id": 10,
      "title": "Port Throughput",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 },
      "collapsed": false
    },
    {
      "id": 11,
      "title": "Send Throughput (Mbps)",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_port_bytes_sent_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short]) * 8 / 1000000",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "rate(interactem_port_bytes_sent_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long]) * 8 / 1000000",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 6 },
      "fieldConfig": {
        "defaults": {
          "unit": "Mbps",
          "color": { "mode": "palette-classic" },
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "id": 12,
      "title": "Receive Throughput (Mbps)",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_port_bytes_received_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short]) * 8 / 1000000",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "rate(interactem_port_bytes_received_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long]) * 8 / 1000000",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 6 },
      "fieldConfig": {
        "defaults": {
          "unit": "Mbps",
          "color": { "mode": "palette-classic" },
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "id": 20,
      "title": "Message Rates",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 14 },
      "collapsed": false
    },
    {
      "id": 21,
      "title": "Send Message Rate",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_port_messages_sent_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short])",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "rate(interactem_port_messages_sent_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long])",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 15 },
      "fieldConfig": {
        "defaults": {
          "unit": "msg/s",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "id": 22,
      "title": "Receive Message Rate",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_port_messages_received_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short])",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "rate(interactem_port_messages_received_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long])",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 15 },
      "fieldConfig": {
        "defaults": {
          "unit": "msg/s",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "id": 30,
      "title": "Edge Analysis",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 23 },
      "collapsed": false
    },
    {
      "id": 31,
      "title": "Edge Message Rate Difference (Input - Output)",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_port_messages_sent_total[$rate_interval_short]) * on(port_id, pipeline_id) group_left(output_port_id) (label_replace(interactem_edge_active, \"port_id\", \"$1\", \"input_port_id\", \"(.*)\"))",
          "legendFormat": "{{input_port_id}}_{{output_port_id}}_input",
          "refId": "INPUT_MSG"
        },
        {
          "expr": "rate(interactem_port_messages_received_total[$rate_interval_short]) * on(port_id, pipeline_id) group_left(input_port_id) (label_replace(interactem_edge_active, \"port_id\", \"$1\", \"output_port_id\", \"(.*)\"))",
          "legendFormat": "{{input_port_id}}_{{output_port_id}}_output",
          "refId": "OUTPUT_MSG"
        }
      ],
      "transformations": [
        {
          "id": "joinByField",
          "options": {
            "byField": "Time",
            "mode": "outer"
          }
        },
        {
          "id": "calculateField",
          "options": {
            "mode": "reduceRow",
            "reduce": {
              "reducer": "diff"
            },
            "replaceFields": true
          }
        },
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              ".*_input": true,
              ".*_output": true
            },
            "renameByName": {
              "Diff": "Message Rate Difference"
            }
          }
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 24 }
    },
    {
      "id": 32,
      "title": "Edge Throughput Difference (Input - Output)",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_port_bytes_sent_total{port_id=~\".*\"}[$rate_interval_short]) * 8 / 1000000 * on(port_id, pipeline_id) group_left(output_port_id) (label_replace(interactem_edge_active, \"port_id\", \"$1\", \"input_port_id\", \"(.*)\"))",
          "legendFormat": "{{input_port_id}}_{{output_port_id}}_input",
          "refId": "INPUT_TH"
        },
        {
          "expr": "rate(interactem_port_bytes_received_total{port_id=~\".*\"}[$rate_interval_short]) * 8 / 1000000 * on(port_id, pipeline_id) group_left(input_port_id) (label_replace(interactem_edge_active, \"port_id\", \"$1\", \"output_port_id\", \"(.*)\"))",
          "legendFormat": "{{input_port_id}}_{{output_port_id}}_output",
          "refId": "OUTPUT_TH"
        }
      ],
      "transformations": [
        {
          "id": "joinByField",
          "options": {
            "byField": "Time",
            "mode": "outer"
          }
        },
        {
          "id": "calculateField",
          "options": {
            "mode": "reduceRow",
            "reduce": {
              "reducer": "diff"
            },
            "replaceFields": true
          }
        },
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              ".*_input": true,
              ".*_output": true
            },
            "renameByName": {
              "Diff": "Throughput Difference"
            }
          }
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 24 },
      "fieldConfig": {
        "defaults": {
          "unit": "Mbps",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          },
          "color": {
            "mode": "thresholds"
          },
          "thresholds": {
            "steps": [
              {
                "color": "red",
                "value": null
              },
              {
                "color": "yellow",
                "value": -0.1
              },
              {
                "color": "green",
                "value": 0
              }
            ]
          }
        }
      }
    },
    {
      "id": 40,
      "title": "Operator Performance",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 32 },
      "collapsed": false
    },
    {
      "id": 41,
      "title": "Processing Time - Latest Values",
      "type": "timeseries",
      "targets": [
        {
          "expr": "interactem_operator_processing_time_latest_microseconds{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}",
          "legendFormat": "{{operator_id}} ({{operator_type}})"
        }
      ],
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 33 },
      "fieldConfig": {
        "defaults": {
          "unit": "µs",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10,
            "showPoints": "always",
            "pointSize": 5
          }
        }
      }
    },
    {
      "id": 42,
      "title": "Processing Time - P95 Percentiles",
      "type": "timeseries",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, rate(interactem_operator_processing_time_histogram_microseconds_bucket{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short]))",
          "legendFormat": "P95 $rate_interval_short - {{operator_id}} ({{operator_type}})"
        },
        {
          "expr": "histogram_quantile(0.95, rate(interactem_operator_processing_time_histogram_microseconds_bucket{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long]))",
          "legendFormat": "P95 $rate_interval_long - {{operator_id}} ({{operator_type}})"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 41 },
      "fieldConfig": {
        "defaults": {
          "unit": "µs",
          "custom": {
            "lineWidth": 2
          }
        }
      }
    },
    {
      "id": 43,
      "title": "Processing Time - Averages",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_operator_processing_time_histogram_microseconds_sum{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short]) / rate(interactem_operator_processing_time_histogram_microseconds_count{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short])",
          "legendFormat": "Avg $rate_interval_short - {{operator_id}} ({{operator_type}})"
        },
        {
          "expr": "rate(interactem_operator_processing_time_histogram_microseconds_sum{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long]) / rate(interactem_operator_processing_time_histogram_microseconds_count{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long])",
          "legendFormat": "Avg $rate_interval_long - {{operator_id}} ({{operator_type}})"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 41 },
      "fieldConfig": {
        "defaults": {
          "unit": "µs",
          "custom": {
            "lineWidth": 2
          }
        }
      }
    },
    {
      "id": 50,
      "title": "Pipeline Status",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 49 },
      "collapsed": false
    },
    {
      "id": 51,
      "title": "Active Ports per Pipeline",
      "type": "timeseries",
      "targets": [
        {
          "expr": "interactem_pipeline_active_ports{pipeline_id=~\"$pipeline_id\"}",
          "legendFormat": "{{pipeline_id}}"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 50 },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        }
      }
    },
    {
      "id": 52,
      "title": "Active Operators per Pipeline",
      "type": "timeseries",
      "targets": [
        {
          "expr": "interactem_pipeline_active_operators{pipeline_id=~\"$pipeline_id\"}",
          "legendFormat": "{{pipeline_id}}"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 50 },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        }
      }
    },
    {
      "id": 60,
      "title": "System Metrics",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 58 },
      "collapsed": false
    },
    {
      "id": 61,
      "title": "Metrics Collection Duration",
      "type": "timeseries",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, rate(interactem_metrics_collection_duration_seconds_bucket[5m]))",
          "legendFormat": "P95"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 59 },
      "fieldConfig": {
        "defaults": {
          "unit": "s"
        }
      }
    },
    {
      "id": 62,
      "title": "Collection Error Rate",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_metrics_collection_errors_total[5m])",
          "legendFormat": "{{error_type}}"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 59 },
      "fieldConfig": {
        "defaults": {
          "unit": "errors/s"
        }
      }
    }
  ]
}
