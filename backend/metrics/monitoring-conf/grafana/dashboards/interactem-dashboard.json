{
  "title": "Interactem Pipeline Monitoring",
  "tags": ["interactem", "prometheus", "pipeline"],
  "timezone": "browser",
  "refresh": "5s",
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "templating": {
    "list": [
      {
        "name": "pipeline_id",
        "type": "query",
        "query": "label_values(interactem_pipeline_active_ports, pipeline_id)",
        "refresh": 1,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "current": {
          "text": "All",
          "value": "$__all"
        },
        "label": "Pipeline ID"
      },
      {
        "name": "operator_type",
        "type": "query",
        "query": "label_values(interactem_runtime_port_messages_sent_total, operator_type)",
        "refresh": 1,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "current": {
          "text": "All",
          "value": "$__all"
        },
        "label": "Operator Type"
      },
      {
        "name": "rate_interval_short",
        "type": "custom",
        "query": "5s,10s,15s,30s",
        "multi": false,
        "includeAll": false,
        "hide": 0,
        "label": "Short Window",
        "skipUrlSync": false,
        "options": [
          { "text": "5 seconds", "value": "5s", "selected": true },
          { "text": "10 seconds", "value": "10s" },
          { "text": "15 seconds", "value": "15s" },
          { "text": "30 seconds", "value": "30s" }
        ]
      },
      {
        "name": "rate_interval_long",
        "type": "custom",
        "query": "30s,1m,2m,5m",
        "multi": false,
        "includeAll": false,
        "hide": 0,
        "label": "Long Window",
        "skipUrlSync": false,
        "options": [
          { "text": "30 seconds", "value": "30s", "selected": true },
          { "text": "1 minute", "value": "1m" },
          { "text": "2 minutes", "value": "2m" },
          { "text": "5 minutes", "value": "5m" }
        ]
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "title": "Service Overview",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 }
    },
    {
      "id": 2,
      "title": "Service Status",
      "type": "stat",
      "targets": [
        {
          "expr": "interactem_service_status",
          "legendFormat": "{{service}}"
        }
      ],
      "gridPos": { "h": 4, "w": 8, "x": 0, "y": 1 },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              { "color": "red", "value": 0 },
              { "color": "green", "value": 1 }
            ]
          },
          "mappings": [
            { "options": { "0": { "text": "Inactive" } }, "type": "value" },
            { "options": { "1": { "text": "Active" } }, "type": "value" }
          ]
        }
      }
    },
    {
      "id": 3,
      "title": "Monitored Pipelines",
      "type": "stat",
      "targets": [
        {
          "expr": "count(count by (pipeline_id) (interactem_pipeline_active_ports))",
          "legendFormat": "Pipelines"
        }
      ],
      "gridPos": { "h": 4, "w": 8, "x": 8, "y": 1 }
    },
    {
      "id": 4,
      "title": "Collected Errors",
      "type": "stat",
      "targets": [
        {
          "expr": "increase(interactem_metrics_collection_errors_total[5m])",
          "legendFormat": "{{error_type}}"
        }
      ],
      "gridPos": { "h": 4, "w": 8, "x": 16, "y": 1 },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              { "color": "green", "value": 0 },
              { "color": "yellow", "value": 1 },
              { "color": "red", "value": 5 }
            ]
          }
        }
      }
    },
    {
      "id": 10,
      "title": "Port Throughput",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 }
    },
    {
      "id": 11,
      "title": "Combined Send Throughput (Mbps)",
      "type": "timeseries",
      "targets": [
        {
          "expr": "sum by (port_id, operator_type) (rate(interactem_runtime_port_bytes_sent_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short])) * 8 / 1000000",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "sum by (port_id, operator_type) (rate(interactem_runtime_port_bytes_sent_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long])) * 8 / 1000000",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 6 },
      "fieldConfig": {
        "defaults": {
          "unit": "Mbps",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "id": 12,
      "title": "Combined Receive Throughput (Mbps)",
      "type": "timeseries",
      "targets": [
        {
          "expr": "sum by (port_id, operator_type) (rate(interactem_runtime_port_bytes_received_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short])) * 8 / 1000000",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "sum by (port_id, operator_type) (rate(interactem_runtime_port_bytes_received_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long])) * 8 / 1000000",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 6 },
      "fieldConfig": {
        "defaults": {
          "unit": "Mbps",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "id": 13,
      "title": "Runtime Ports Send Throughput (Stacked)",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_runtime_port_bytes_sent_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short]) * 8 / 1000000",
          "legendFormat": "{{runtime_port_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "rate(interactem_runtime_port_bytes_sent_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long]) * 8 / 1000000",
          "legendFormat": "{{runtime_port_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 10, "w": 12, "x": 0, "y": 14 },
      "fieldConfig": {
        "defaults": {
          "unit": "Mbps",
          "custom": {
            "lineWidth": 1,
            "fillOpacity": 40,
            "stacking": {
              "mode": "normal"
            }
          }
        }
      },
      "options": {
        "tooltip": {
          "mode": "multi",
          "sort": "desc"
        }
      }
    },
    {
      "id": 14,
      "title": "Runtime Ports Receive Throughput (Stacked)",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_runtime_port_bytes_received_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short]) * 8 / 1000000",
          "legendFormat": "{{runtime_port_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "rate(interactem_runtime_port_bytes_received_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long]) * 8 / 1000000",
          "legendFormat": "{{runtime_port_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 10, "w": 12, "x": 12, "y": 14 },
      "fieldConfig": {
        "defaults": {
          "unit": "Mbps",
          "custom": {
            "lineWidth": 1,
            "fillOpacity": 40,
            "stacking": {
              "mode": "normal"
            }
          }
        }
      },
      "options": {
        "tooltip": {
          "mode": "multi",
          "sort": "desc"
        }
      }
    },
    {
      "id": 20,
      "title": "Message Rates",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 24 }
    },
    {
      "id": 21,
      "title": "Combined Send Message Rate",
      "type": "timeseries",
      "targets": [
        {
          "expr": "sum by (port_id, operator_type) (rate(interactem_runtime_port_messages_sent_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short]))",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "sum by (port_id, operator_type) (rate(interactem_runtime_port_messages_sent_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long]))",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 25 },
      "fieldConfig": {
        "defaults": {
          "unit": "msg/s",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "id": 22,
      "title": "Combined Receive Message Rate",
      "type": "timeseries",
      "targets": [
        {
          "expr": "sum by (port_id, operator_type) (rate(interactem_runtime_port_messages_received_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short]))",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "sum by (port_id, operator_type) (rate(interactem_runtime_port_messages_received_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long]))",
          "legendFormat": "{{port_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 25 },
      "fieldConfig": {
        "defaults": {
          "unit": "msg/s",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "id": 23,
      "title": "Runtime Send Message Rates (Stacked)",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_runtime_port_messages_sent_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short])",
          "legendFormat": "{{runtime_port_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "rate(interactem_runtime_port_messages_sent_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long])",
          "legendFormat": "{{runtime_port_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 10, "w": 12, "x": 0, "y": 33 },
      "fieldConfig": {
        "defaults": {
          "unit": "msg/s",
          "custom": {
            "lineWidth": 1,
            "fillOpacity": 40,
            "stacking": {
              "mode": "normal"
            }
          }
        }
      },
      "options": {
        "tooltip": {
          "mode": "multi",
          "sort": "desc"
        }
      }
    },
    {
      "id": 24,
      "title": "Runtime Receive Message Rates (Stacked)",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_runtime_port_messages_received_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short])",
          "legendFormat": "{{runtime_port_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "rate(interactem_runtime_port_messages_received_total{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long])",
          "legendFormat": "{{runtime_port_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 10, "w": 12, "x": 12, "y": 33 },
      "fieldConfig": {
        "defaults": {
          "unit": "msg/s",
          "custom": {
            "lineWidth": 1,
            "fillOpacity": 40,
            "stacking": {
              "mode": "normal"
            }
          }
        }
      },
      "options": {
        "tooltip": {
          "mode": "multi",
          "sort": "desc"
        }
      }
    },
    {
      "id": 30,
      "title": "Operator Performance",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 43 }
    },
    {
      "id": 31,
      "title": "Combined Processing Time - Latest Values",
      "type": "timeseries",
      "targets": [
        {
          "expr": "max by (operator_id, operator_type) (interactem_runtime_operator_processing_time_latest_microseconds{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"})",
          "legendFormat": "{{operator_id}} ({{operator_type}})"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 44 },
      "fieldConfig": {
        "defaults": {
          "unit": "µs",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10,
            "showPoints": "always",
            "pointSize": 5
          }
        }
      }
    },
    {
      "id": 32,
      "title": "Runtime Processing Times - Latest Values",
      "type": "timeseries",
      "targets": [
        {
          "expr": "interactem_runtime_operator_processing_time_latest_microseconds{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}",
          "legendFormat": "{{runtime_operator_id}} ({{operator_type}})"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 44 },
      "fieldConfig": {
        "defaults": {
          "unit": "µs",
          "custom": {
            "lineWidth": 1,
            "fillOpacity": 5,
            "showPoints": "always",
            "pointSize": 3
          }
        }
      }
    },
    {
      "id": 33,
      "title": "Combined Processing Time - P95 Percentiles",
      "type": "timeseries",
      "targets": [
        {
          "expr": "max by (operator_id, operator_type) (histogram_quantile(0.95, rate(interactem_runtime_operator_processing_time_histogram_microseconds_bucket{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short])))",
          "legendFormat": "P95 {{operator_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "max by (operator_id, operator_type) (histogram_quantile(0.95, rate(interactem_runtime_operator_processing_time_histogram_microseconds_bucket{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long])))",
          "legendFormat": "P95 {{operator_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 52 },
      "fieldConfig": {
        "defaults": {
          "unit": "µs",
          "custom": {
            "lineWidth": 2
          }
        }
      }
    },
    {
      "id": 34,
      "title": "Runtime Processing Times - P95 Percentiles",
      "type": "timeseries",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, rate(interactem_runtime_operator_processing_time_histogram_microseconds_bucket{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short]))",
          "legendFormat": "P95 {{runtime_operator_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "histogram_quantile(0.95, rate(interactem_runtime_operator_processing_time_histogram_microseconds_bucket{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long]))",
          "legendFormat": "P95 {{runtime_operator_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 52 },
      "fieldConfig": {
        "defaults": {
          "unit": "µs",
          "custom": {
            "lineWidth": 1
          }
        }
      }
    },
    {
      "id": 35,
      "title": "Combined Processing Time - Averages",
      "type": "timeseries",
      "targets": [
        {
          "expr": "avg by (operator_id, operator_type) (avg_over_time(interactem_runtime_operator_processing_time_latest_microseconds{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short]))",
          "legendFormat": "Avg {{operator_id}} ({{operator_type}}) - $rate_interval_short"
        },
        {
          "expr": "avg by (operator_id, operator_type) (avg_over_time(interactem_runtime_operator_processing_time_latest_microseconds{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long]))",
          "legendFormat": "Avg {{operator_id}} ({{operator_type}}) - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 60 },
      "fieldConfig": {
        "defaults": {
          "unit": "µs",
          "custom": {
            "lineWidth": 2
          }
        }
      }
    },
    {
      "id": 36,
      "title": "Runtime Processing Time - Averages",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_runtime_operator_processing_time_histogram_microseconds_sum{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short]) / rate(interactem_runtime_operator_processing_time_histogram_microseconds_count{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_short])",
          "legendFormat": "Avg {{runtime_operator_id}} [{{operator_type}}] - $rate_interval_short"
        },
        {
          "expr": "rate(interactem_runtime_operator_processing_time_histogram_microseconds_sum{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long]) / rate(interactem_runtime_operator_processing_time_histogram_microseconds_count{pipeline_id=~\"$pipeline_id\", operator_type=~\"$operator_type\"}[$rate_interval_long])",
          "legendFormat": "Avg {{runtime_operator_id}} [{{operator_type}}] - $rate_interval_long"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 60 },
      "fieldConfig": {
        "defaults": {
          "unit": "µs",
          "custom": {
            "lineWidth": 1
          }
        }
      }
    },
    {
      "id": 40,
      "title": "Pipeline Status",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 68 }
    },
    {
      "id": 41,
      "title": "Active Ports per Pipeline",
      "type": "timeseries",
      "targets": [
        {
          "expr": "interactem_pipeline_active_ports{pipeline_id=~\"$pipeline_id\"}",
          "legendFormat": "{{pipeline_id}}"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 69 },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        }
      }
    },
    {
      "id": 42,
      "title": "Active Operators per Pipeline",
      "type": "timeseries",
      "targets": [
        {
          "expr": "interactem_pipeline_active_operators{pipeline_id=~\"$pipeline_id\"}",
          "legendFormat": "{{pipeline_id}}"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 69 },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        }
      }
    },
    {
      "id": 50,
      "title": "System Metrics",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 77 }
    },
    {
      "id": 51,
      "title": "Metrics Collection Duration",
      "type": "timeseries",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, rate(interactem_metrics_collection_duration_seconds_bucket[5m]))",
          "legendFormat": "P95"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 78 },
      "fieldConfig": {
        "defaults": {
          "unit": "s"
        }
      }
    },
    {
      "id": 52,
      "title": "Collection Error Rate",
      "type": "timeseries",
      "targets": [
        {
          "expr": "rate(interactem_metrics_collection_errors_total[5m])",
          "legendFormat": "{{error_type}}"
        }
      ],
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 78 },
      "fieldConfig": {
        "defaults": {
          "unit": "errors/s"
        }
      }
    }
  ]
}
